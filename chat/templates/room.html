
{% extends "base.html" %}
{% block support %}active{% endblock support %}
{% block breadcrumbt %}
<li class="breadcrumb-item "><a a class="text-light" href="{% url "main_dashboard" %}">Dashboard</a></li>
<li class="breadcrumb-item "><a a class="text-light" href="{% url "chat-page" %}">Support Chat</a></li>
<li class="breadcrumb-item "><a a class="text-primary" href="">{{room.user.fullName }}</a></li>
   
{% endblock breadcrumbt %}
{% block content %}
<style>
    .message-date {
        font-size: 0.7em;
        color: #fff;
        border-radius: 5px;
        max-width: 60%;
        min-width: 30%;
        text-align: center;
        margin-top: 5px;
    }
    
    .message-text {
        
        padding: 12px 18px;
        border-radius: 20px;
        border: 1px solid #ccc;
        max-width: 100%; /* Keep the max width */
        border-top-right-radius: 5px;
        clear: both;
        background-color: #fff;
        color: #333;
        
        /* Prevent long text from overflowing */
        word-wrap: break-word; 
        overflow-wrap: break-word; 
        white-space: pre-wrap; /* Preserve newlines */
        text-align: left; /* Ensure text alignment */
    }

    .sender-message-text {
        
        padding: 12px 18px;
        border-radius: 20px;
        border: 1px solid #ccc;
        max-width: 100%; /* Keep the max width */
        border-top-left-radius: 5px;
        clear: both;
        background-color: #fff;
        color: #333;
        
        /* Prevent long text from overflowing */
        word-wrap: break-word; 
        overflow-wrap: break-word; 
        white-space: pre-wrap; /* Preserve newlines */
        text-align: left; /* Ensure text alignment */
    }
    
    .chat-container {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .chat-box {
        height: 80vh;
        border: 1px solid #FF8300;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .chat-header {
        background-color: #FF8300;
        color: white;
        padding: 10px;
        text-align: right;
        font-size: 18px;
        border-bottom: 2px solid #FF8300;
    }
    
    .chat-log {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .chat-input {
        display: flex;
        padding: 10px;
        background-color: #fff;
        border-top: 1px solid #dee2e6;
    }
    
    .chat-input input {
        flex-grow: 1;
        padding: 10px;
        border-radius: 20px;
        border: 1px solid #ced4da;
    }
    
    .chat-input button {
        margin-left: 10px;
        padding: 10px 20px;
        border-radius: 20px;
    }
    
    .chat-log::-webkit-scrollbar {
        width: 8px;
    }
    
    .chat-log::-webkit-scrollbar-thumb {
        background-color: #adb5bd;
        border-radius: 4px;
    }
    
    .chat-message {
        margin-bottom: 5px;
        padding: 10px;
        border-radius: 20px;
        max-width: 75%;
        clear: both;
        background-color: #000;
        color: #333;
        
    }
    
    .message-sender {
        background-color: transparent;
        color: white;
        float: left;
        text-align: left;
        padding: 12px 18px;
        border-radius: 10px;
        border-top-right-radius: 5px;
        max-width: 75%;
        
    }
    
    .message-receiver {
        background-color:transparent;
        color: #fff;
        float: right;
        text-align: right;
        margin-left: auto;
        padding: 12px 18px;
        border-radius: 20px;
        
        max-width: 75%;
        
    }
    
    .chat-message:after {
        content: '';
        display: table;
        clear: both;
    }
    
    </style>

    <div class="container-fluid chat-container">
        <div class="col-md-6 col-lg-8">
            <div class="chat-box shadow">
                <!-- Chat Header -->
                <div class="chat-header text-center">
                    <div
                        class="row justify-content-center align-items-center g-2"
                    >
                        <div class="col">الاسم</div>
                        <div class="col">رقم الهاتف</div>
                        <div class="col">نوع الحساب</div>
                    </div>
                    <div
                        class="row justify-content-center align-items-center g-2"
                    >
                        <div class="col">{{ room.user.fullName }}</div>
                        <div class="col">{{ room.user.phone }}</div>
                        <div class="col">
                            {% if room.user.driver  %}
                            مندوب
                            {% elif room.user.restaurant %}
                            مطعم
                            {% else %}
                            عميل
                            {% endif %}
                        </div>
                    </div>
                     
                </div>
                <!-- Chat Log Area -->
                <div id="chat-log" class="chat-log bg-dark">
                    <!-- Display previous messages -->
                    {% for message in room.messages.all %}
                        <div class="chat-message  {% if message.sender.id == room.user.id %} message-sender {% else %} message-receiver {% endif %}">
                        {% if message.sender.id == room.user.id %} {{message.sender.fullName}} {% else %} Me {% endif %}
                            
                            {% spaceless %}
                            {% if message.sender.id == room.user.id %}  <div class="sender-message-text">{{ message.content}}</div> {% else %}  <div class="message-text">{{ message.content}}</div> {% endif %}
                           
                            {% endspaceless %}
                            
                            <div class="message-date m-0">{{ message.timestamp|date:"SHORT_DATE_FORMAT" }} {{ message.timestamp|time:"H:i" }}</div>
                        </div>
                    {% endfor %}

                
                </div>
                <!-- Chat Input Area -->
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Type a message..." class="form-control">
                    <button id="sendButton" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const roomId = "{{ room.id }}";
        const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomId + '/');
        const chatLog = document.querySelector('#chat-log');
        const messageInput = document.querySelector('#messageInput');
        const sendButton = document.querySelector('#sendButton');
        
        let isPageFocused = true;  // Track if the page is focused
    
        // طلب الإذن بالإشعارات
        function requestNotificationPermission() {
            if (Notification.permission === "granted") {
                console.log("إشعارات مفعّلة بالفعل.");
            } else if (Notification.permission === "denied") {
                console.log("تم رفض الإذن للإشعارات.");
            } else {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        console.log("تم السماح بالإشعارات.");
                    } else {
                        console.log("تم رفض الإذن بالإشعارات.");
                    }
                });
            }
        }
    
        // عرض الإشعار عند وصول رسالة جديدة
        function showNotification(sender, message) {
            if (Notification.permission === "granted") {
                const notification = new Notification(`${sender} says:`, {
                    body: message,
                   
                });
    
                // تركز على نافذة المتصفح عند النقر على الإشعار
                notification.onclick = () => {
                    window.focus();
                };
            } else {
                console.log("إشعارات غير مفعلة.");
            }
        }
    
        // تغيير عنوان الصفحة عند استلام رسالة جديدة
        function changeTitleForNewMessage() {
            if (!isPageFocused) {
                document.title = "New Message!";
            }
        }
    
        // تمرير الصفحة إلى أسفل
        function scrollToBottom() {
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messageElement = document.createElement('div');
            const textElement = document.createElement('div');
            const dateElement = document.createElement('div');
            const senderElement = document.createElement('div');
            messageElement.classList.add('chat-message');
            // إضافة صف بناءً على المرسل
            if (data.sender === {{ room.user.id }}) {
                
                messageElement.classList.add('message-sender');
                senderElement.textContent = '{{ room.user.fullName }}';
                textElement.classList.add('sender-message-text');
            } else {
                messageElement.classList.add('message-receiver');
                senderElement.textContent = "Me";
                textElement.classList.add('message-text');
            }
    
            dateElement.textContent = data.date + ' ' + data.time;
            dateElement.classList.add('message-date');
          
            textElement.textContent = data.message;
            
            messageElement.appendChild(senderElement);
            messageElement.appendChild(textElement);
            messageElement.appendChild(dateElement);
            chatLog.appendChild(messageElement);
            scrollToBottom();
    
            // إذا كان المرسل ليس المستخدم الحالي، أرسل إشعار
            if (data.sender === {{ room.user.id}}) {
                console.log(data.sender)
                showNotification(senderElement.textContent, textElement.textContent);
                changeTitleForNewMessage();  // تغيير العنوان عند وصول رسالة جديدة
            }
        };
    
        sendButton.onclick = function() {
            const message = messageInput.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = ''; // تفريغ حقل الإدخال
        };
    
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };
    
        // تمرير الصفحة إلى أسفل عند تحميلها
        window.onload = function() {
            scrollToBottom();
            requestNotificationPermission(); // طلب الإذن بالإشعارات عند التحميل
        };
    
        // الكشف إذا كانت الصفحة في وضع التركيز أم لا
        window.onfocus = function() {
            isPageFocused = true;
            document.title = "Chat";  // إعادة العنوان عند التركيز على الصفحة
        };
    
        window.onblur = function() {
            isPageFocused = false;
        };
    </script>
        {% endblock content %}
